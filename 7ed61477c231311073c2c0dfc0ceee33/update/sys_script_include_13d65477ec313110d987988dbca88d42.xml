<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_165694_time_of_0.TimeOffDateValidation</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <name>TimeOffDateValidation</name>
        <script><![CDATA[var TimeOffDateValidation = Class.create();
TimeOffDateValidation.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {

 startDate: function() {
        var obj = {
            status: false,
            message: ""
        };
        try {
            var date = this.getParameter('sysparm_date');
            var tableName = this.getParameter('sysparm_tableName');
            var endDt = this.getParameter('sysparm_enddate');

            var currentDate = new GlideDateTime();

            var startDate = new GlideDateTime(date);
    
            obj.status = startDate.getDate() < currentDate.getDate();
            if (obj.status) {
                obj.message = gs.getMessage("Start date cannot be before today.");
                return JSON.stringify(obj);
            }


            if (global.JSUtil.notNil(endDt)) {
                var endDate = new GlideDateTime();
                endDate.setValue(endDt);
                obj.status = endDate.getDate() < startDate.getDate();

                if (obj.status) {
                    obj.message = gs.getMessage("Start date cannot be after the end date.");
                    return JSON.stringify(obj);
                }
            }

            var isValid = this.validateRecord(date, tableName);

            obj.status = isValid.status;
            if (obj.status) {
                obj.message = gs.getMessage("Record already exists for the selected start date {0}", isValid.record.start_date != isValid.record.end_date ? " between " + isValid.record.start_date + " and " + isValid.record.end_date + "." : isValid.record.start_date);
                return JSON.stringify(obj);
            } else {
                return JSON.stringify(obj);
            }
        } catch (e) {
            gs.error("TimeOffDateValidation start date error: " + e);
            obj.status = true;
            obj.message = gs.getMessage("There was an error. Please contact the system administrator.");
            return JSON.stringify(obj);
        }

    },

    validateRecord: function(date, tableName) {

        var gr = new GlideRecord(tableName);
        var query = "requested_byDYNAMIC90d1921e5f510100a9ad2572f2b477fe^statusINrequested,approved";

        if (global.JSUtil.notNil(date))
            query += "^start_date<=javascript:gs.dateGenerate('" + date + "','start')^end_date>=javascript:gs.dateGenerate('" + date + "','end')";

        gr.addEncodedQuery(query);
        gr.query();
        if (gr.next())
            return {
                status: true,
                record: gr
            };
        else
            return {
                status: false,
                record: ""
            };
    },

 loggedInUserDateformat: function(date, userID) {
        var dateFormat = '';
        userID = userID || gs.getUserID();
        var userObj = new GlideRecord('sys_user');
        if (userObj.get(userID)) {
            dateFormat = userObj.getValue('date_format');
        }
        if (dateFormat == null || dateFormat == '') {
            return date+' '+"00:00:00";
        } else if (dateFormat.indexOf("MM-dd-yyyy") == "0") {
            date = date.split(' ');
            formatTime = date[1] || "00:00:00";
            formatDate = date[0];
            formatDate = formatDate.split('-');
            date = formatDate[2] + "-" + formatDate[0] + "-" + formatDate[1] + ' ' + formatTime;
            return date;
        } else if (dateFormat.indexOf("dd-MM-yyyy") == "0") {
            date = date.split(' ');
            formatTime = date[1] || "00:00:00";
            formatDate = date[0];
            formatDate = formatDate.split('-');
            date = formatDate[2] + "-" + formatDate[1] + "-" + formatDate[0] + ' ' + formatTime;
            return date;

        } else if (dateFormat.indexOf("yyyy-MM-dd") == "0") {
            date = date.split(' ');
            formatTime = date[1] || "00:00:00";
            formatDate = date[0];
            formatDate = formatDate.split('-');
            date = formatDate[0] + "-" + formatDate[1] + "-" + formatDate[2] + ' ' + formatTime;
            return date;
        } else if (dateFormat.indexOf("dd/MM/yyyy") == "0") {
            date = date.split(' ');
            formatTime = date[1] || "00:00:00";
            formatDate = date[0];
            formatDate = formatDate.split('/');
            date = formatDate[2] + "-" + formatDate[1] + "-" + formatDate[0] + ' ' + formatTime;
            return date;
        } else if (dateFormat.indexOf("dd.MM.yyyy") == "0") {
            date = date.split(' ');
            formatTime = date[1] || "00:00:00";
            formatDate = date[0];
            formatDate = formatDate.split('.');
            date = formatDate[2] + "-" + formatDate[1] + "-" + formatDate[0] + ' ' + formatTime;
            return date;
        }
    },



 endDate: function() {
        var obj = {
            status: false,
            message: ""
        };
        try {
            var end_date = this.getParameter('sysparm_end');
            var start_date = this.getParameter('sysparm_start') || new GlideDateTime();
            var tableName = this.getParameter('sysparm_tableName');


            var startGdt = new GlideDateTime(start_date);

            var endGdt = new GlideDateTime(end_date);

            var currentDate = new GlideDateTime();

            obj.status = endGdt.getDate() < startGdt.getDate() || endGdt.getDate() < currentDate.getDate();

            if (obj.status) {
                obj.message = gs.getMessage("End date cannot be before today or the start date.");
                return JSON.stringify(obj);
            }

            var isValid = this.validateRecord(end_date, tableName);

            obj.status = isValid.status;
            if (obj.status) {
                obj.message = gs.getMessage("Record already exists for the selected end date {0}", isValid.record.start_date != isValid.record.end_date ? " between " + isValid.record.start_date + " and " + isValid.record.end_date + "." : isValid.record.start_date);
                return JSON.stringify(obj);
            } else {
                return JSON.stringify(obj);
            }
        } catch (e) {
            gs.error("TimeOffDateValidation the end date error: " + e);
            obj.status = true;
            obj.message = gs.getMessage("There was an error. Please contact the system administrator.");
            return JSON.stringify(obj);
        }

    },



    type: 'TimeOffDateValidation'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-10-17 01:23:45</sys_created_on>
        <sys_id>13d65477ec313110d987988dbca88d42</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>TimeOffDateValidation</sys_name>
        <sys_package display_value="Time Off Tracker" source="x_165694_time_of_0">7ed61477c231311073c2c0dfc0ceee33</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Time Off Tracker">7ed61477c231311073c2c0dfc0ceee33</sys_scope>
        <sys_update_name>sys_script_include_13d65477ec313110d987988dbca88d42</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-10-17 01:23:45</sys_updated_on>
    </sys_script_include>
</record_update>
